<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Studio Pro - Fami Collection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --ps-dark: #1e1e1e;
            --ps-medium: #2d2d2d;
            --ps-light: #3c3c3c;
            --ps-accent: #0078d4;
            --ps-text: #cccccc;
        }

        body {
            background-color: var(--ps-dark);
            color: var(--ps-text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            height: 100vh;
            user-select: none;
        }

        .app-header {
            height: 50px;
            background-color: var(--ps-medium);
            border-bottom: 1px solid #111;
            display: flex;
            align-items: center;
            padding: 0 15px;
            z-index: 50;
        }

        .side-bar { width: 50px; background-color: var(--ps-medium); border-right: 1px solid #111; }
        .right-panel { width: 280px; background-color: var(--ps-medium); border-left: 1px solid #111; }
        .main-workspace { background-color: #111; overflow: auto; position: relative; flex-grow: 1; }

        .canvas-container {
            padding: 50px;
            display: flex;
            justify-content: center;
            min-width: fit-content;
        }

        .paper-canvas {
            background-color: white;
            background-image: 
                linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
                linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
                linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            position: relative;
            box-sizing: border-box;
            overflow: hidden;
        }

        .size-a4 { width: 210mm; height: 297mm; }
        .size-f4 { width: 215mm; height: 330mm; }
        .size-a3 { width: 297mm; height: 420mm; }

        .photo-layer {
            position: absolute;
            border: 1px solid rgba(0,120,212, 0.5);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            cursor: move;
            background-color: #eee;
            print-color-adjust: exact;
            -webkit-print-color-adjust: exact;
            box-sizing: border-box;
            touch-action: none;
        }

        .photo-layer.active {
            border: 2px solid var(--ps-accent);
            z-index: 100;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        .photo-layer::after {
            content: attr(data-size);
            position: absolute;
            bottom: -15px;
            left: 0;
            color: #666;
            font-size: 9px;
            white-space: nowrap;
        }

        .tab-btn {
            font-size: 9px;
            font-weight: bold;
            padding: 6px 4px;
            border-bottom: 2px solid transparent;
            color: #666;
        }
        .tab-btn.active {
            border-bottom-color: var(--ps-accent);
            color: white;
        }

        @media print {
            @page { margin: 0; size: auto; }
            body { background: white !important; margin: 0 !important; padding: 0 !important; }
            .no-print, .app-header { display: none !important; }
            .main-workspace { background: white !important; padding: 0 !important; margin: 0 !important; overflow: visible !important; display: block !important;}
            .canvas-container { padding: 0 !important; margin: 0 !important; display: block !important; }
            .paper-canvas {
                box-shadow: none !important;
                background: white !important;
                background-image: none !important;
                margin: 0 !important;
                border: none !important;
                position: relative !important;
            }
            .photo-layer { border: none !important; }
            .photo-layer::after { display: none !important; }
        }
        
        #loadingOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .instruction-tip {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 10px;
            color: #aaa;
            pointer-events: none;
        }
    </style>
</head>
<body class="flex flex-col">

    <div id="loadingOverlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div>
        <p class="text-sm font-bold uppercase tracking-widest">Memproses PDF...</p>
    </div>

    <!-- Header Bersih tanpa Menu Navigasi -->
    <header class="app-header no-print">
        <div class="flex items-center gap-3">
            <img src="https://iili.io/qHtJoKX.png" alt="Logo" class="h-8 w-auto object-contain">
            <div class="h-6 w-px bg-gray-700 mx-1"></div>
            <h1 class="text-xs font-bold tracking-tighter text-white uppercase italic">Photo Print Studio <span class="text-blue-500">Fami Collection</span></h1>
        </div>
        <!-- Menu navigasi kanan telah dihapus -->
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar Minimalis -->
        <div class="side-bar flex flex-col items-center py-4 no-print">
            <div id="sidebarPaperLabel" class="mt-auto p-2 text-gray-700 text-[10px] font-bold">A4</div>
        </div>

        <div class="main-workspace no-print-bg">
            <div class="instruction-tip no-print">Klik dan tarik foto untuk mengatur posisi di kanvas</div>
            <div class="canvas-container">
                <div id="printArea" class="paper-canvas size-a4">
                    <!-- Foto akan muncul di sini -->
                </div>
            </div>
        </div>

        <div class="right-panel flex flex-col no-print">
            <div class="p-4 border-bottom border-black overflow-y-auto max-h-[60vh]">
                <h3 class="text-xs font-bold uppercase tracking-wider text-white mb-4">PENGATURAN FOTO</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] block mb-1 text-gray-500 font-bold uppercase">Ukuran Kertas</label>
                        <select id="paperSelect" onchange="updatePaperSize()" class="w-full bg-[#111] border border-gray-600 text-xs p-1.5 text-white">
                            <option value="size-a4" selected>A4 (210 x 297 mm)</option>
                            <option value="size-f4">F4 / Folio (215 x 330 mm)</option>
                            <option value="size-a3">A3 (297 x 420 mm)</option>
                        </select>
                    </div>

                    <hr class="border-gray-700">

                    <div>
                        <label class="text-[10px] block mb-1 text-gray-500 font-bold uppercase">Unggah Foto</label>
                        <input type="file" id="imageInput" accept="image/*" class="hidden">
                        <button onclick="document.getElementById('imageInput').click()" class="w-full bg-ps-light hover:bg-gray-600 border border-gray-500 py-1.5 text-xs rounded text-white transition">
                            Pilih Gambar
                        </button>
                        <div id="fileNameDisplay" class="text-[10px] mt-1 text-blue-400 italic truncate text-center">Belum dipilih</div>
                    </div>

                    <hr class="border-gray-700">

                    <div>
                        <div class="flex border-b border-gray-700 mb-3">
                            <button id="tabPreset" onclick="switchMode('preset')" class="tab-btn active flex-1 uppercase">Preset</button>
                            <button id="tabCustom" onclick="switchMode('custom')" class="tab-btn flex-1 uppercase">Kustom</button>
                        </div>

                        <div id="presetView" class="space-y-3">
                            <select id="sizeSelect" class="w-full bg-[#111] border border-gray-600 text-xs p-1.5 text-white">
                                <optgroup label="Pas Foto" class="bg-gray-800">
                                    <option value="20x30">2 x 3 cm</option>
                                    <option value="30x40">3 x 4 cm</option>
                                    <option value="40x60">4 x 6 cm</option>
                                </optgroup>
                                <optgroup label="Ukuran Populer" class="bg-gray-800">
                                    <option value="60x90">2R (6 x 9 cm)</option>
                                    <option value="89x127">3R (8.9 x 12.7 cm)</option>
                                    <option value="102x152" selected>4R (10 x 15 cm)</option>
                                    <option value="127x178">5R (12.7 x 17.8 cm)</option>
                                    <option value="203x254">8R (20.3 x 25.4 cm)</option>
                                    <option value="210x297">Full A4</option>
                                </optgroup>
                            </select>
                        </div>

                        <div id="customView" class="hidden space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="customWidth" value="10" class="bg-[#111] border border-gray-600 text-xs p-1.5 text-white" placeholder="Lebar">
                                <input type="number" id="customHeight" value="15" class="bg-[#111] border border-gray-600 text-xs p-1.5 text-white" placeholder="Tinggi">
                            </div>
                            <select id="customUnit" class="w-full bg-[#111] border border-gray-600 text-xs p-1.5 text-white">
                                <option value="cm">cm</option>
                                <option value="mm">mm</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <select id="orientSelect" class="w-full bg-[#111] border border-gray-600 text-xs p-1.5 text-white">
                            <option value="portrait">Potret</option>
                            <option value="landscape">Lanskap</option>
                        </select>
                        <button onclick="addPhoto()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-1.5 text-xs rounded uppercase tracking-wider">Tambah</button>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <button onclick="handlePrintAction()" class="w-full bg-green-700 hover:bg-green-600 text-white font-bold py-2 text-[10px] rounded shadow-lg uppercase transition active:scale-95">
                            Cetak
                        </button>
                        <button onclick="downloadPDFDirect()" class="w-full bg-red-700 hover:bg-red-600 text-white font-bold py-2 text-[10px] rounded shadow-lg uppercase transition active:scale-95">
                            Download PDF
                        </button>
                    </div>
                </div>
            </div>

            <!-- Panel Layer -->
            <div class="flex-1 flex flex-col border-t border-[#111]">
                <div class="bg-ps-light px-4 py-1.5 text-[10px] font-bold text-white flex justify-between items-center">
                    DAFTAR FOTO <span class="bg-black px-2 rounded-full" id="layerCount">0</span>
                </div>
                <div id="layerList" class="flex-1 overflow-y-auto bg-ps-medium p-1 text-[10px]">
                    <div class="text-gray-500 text-center mt-4 italic">Kanvas kosong</div>
                </div>
                <div class="bg-ps-light h-10 flex items-center justify-around border-t border-black px-2">
                    <button onclick="autoLayout()" class="text-[9px] text-blue-400 hover:text-blue-300 uppercase font-bold">Rapi Otomatis</button>
                    <div class="w-px h-4 bg-gray-700"></div>
                    <button onclick="clearAll()" class="text-[9px] text-gray-400 hover:text-red-500 uppercase">Hapus Semua</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="h-6 bg-ps-medium border-t border-black flex items-center px-4 text-[10px] text-gray-500 no-print">
        <div class="mr-4" id="statusBarPaper">Kanvas: A4</div>
        <div class="ml-auto opacity-50 tracking-widest uppercase">Fami Collection v2.8 • Interactive Layout</div>
    </footer>

    <script>
        const imageInput = document.getElementById('imageInput');
        const paperSelect = document.getElementById('paperSelect');
        const sizeSelect = document.getElementById('sizeSelect');
        const orientSelect = document.getElementById('orientSelect');
        const printArea = document.getElementById('printArea');
        const layerList = document.getElementById('layerList');
        const layerCountLabel = document.getElementById('layerCount');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const statusBarPaper = document.getElementById('statusBarPaper');
        const sidebarLabel = document.getElementById('sidebarPaperLabel');
        const loadingOverlay = document.getElementById('loadingOverlay');

        let currentImageData = null;
        let layers = [];
        let activeMode = 'preset';
        
        let isDragging = false;
        let currentTarget = null;
        let startX, startY, initialLeft, initialTop;

        function switchMode(mode) {
            activeMode = mode;
            document.getElementById('presetView').classList.toggle('hidden', mode !== 'preset');
            document.getElementById('customView').classList.toggle('hidden', mode === 'preset');
            document.getElementById('tabPreset').classList.toggle('active', mode === 'preset');
            document.getElementById('tabCustom').classList.toggle('active', mode !== 'preset');
        }

        function updatePaperSize() {
            const selectedSize = paperSelect.value;
            printArea.className = `paper-canvas ${selectedSize}`;
            statusBarPaper.textContent = `Kanvas: ${paperSelect.options[paperSelect.selectedIndex].text}`;
            sidebarLabel.textContent = paperSelect.options[paperSelect.selectedIndex].text.split(' ')[0];
        }

        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                fileNameDisplay.textContent = file.name;
                const reader = new FileReader();
                reader.onload = (event) => { currentImageData = event.target.result; };
                reader.readAsDataURL(file);
            }
        });

        function addPhoto() {
            if (!currentImageData) return alert('Pilih foto terlebih dahulu!');

            let width, height, label;
            const orientation = orientSelect.value;

            if (activeMode === 'preset') {
                const sizeValue = sizeSelect.value;
                [width, height] = sizeValue.split('x');
                label = sizeSelect.options[sizeSelect.selectedIndex].text;
            } else {
                let w = parseFloat(document.getElementById('customWidth').value);
                let h = parseFloat(document.getElementById('customHeight').value);
                const unit = document.getElementById('customUnit').value;
                label = `Kustom (${w}x${h} ${unit})`;
                width = (unit === 'cm') ? w * 10 : w;
                height = (unit === 'cm') ? h * 10 : h;
            }

            if (orientation === 'landscape') [width, height] = [height, width];

            const layerId = Date.now();
            const photoDiv = document.createElement('div');
            photoDiv.className = 'photo-layer';
            photoDiv.id = `layer-${layerId}`;
            photoDiv.style.width = width + 'mm';
            photoDiv.style.height = height + 'mm';
            photoDiv.style.backgroundImage = `url('${currentImageData}')`;
            photoDiv.setAttribute('data-size', `${Math.round(width/10)}x${Math.round(height/10)}cm`);
            
            photoDiv.style.left = '5mm';
            photoDiv.style.top = '5mm';
            
            setupDragEvents(photoDiv);

            printArea.appendChild(photoDiv);
            addLayerItem(layerId, label, currentImageData);
            updateStatus();
        }

        function setupDragEvents(el) {
            const handleStart = (e) => {
                isDragging = true;
                currentTarget = el;
                el.classList.add('active');
                
                const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                
                startX = clientX;
                startY = clientY;
                initialLeft = parseInt(el.style.left) || 0;
                initialTop = parseInt(el.style.top) || 0;
                
                printArea.appendChild(el);
            };

            el.addEventListener('mousedown', handleStart);
            el.addEventListener('touchstart', handleStart);
        }

        window.addEventListener('mousemove', (e) => {
            if (!isDragging || !currentTarget) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            currentTarget.style.left = (initialLeft + dx) + 'px';
            currentTarget.style.top = (initialTop + dy) + 'px';
        });

        window.addEventListener('touchmove', (e) => {
            if (!isDragging || !currentTarget) return;
            const dx = e.touches[0].clientX - startX;
            const dy = e.touches[0].clientY - startY;
            currentTarget.style.left = (initialLeft + dx) + 'px';
            currentTarget.style.top = (initialTop + dy) + 'px';
        });

        window.addEventListener('mouseup', () => {
            if (currentTarget) currentTarget.classList.remove('active');
            isDragging = false;
            currentTarget = null;
        });

        window.addEventListener('touchend', () => {
            if (currentTarget) currentTarget.classList.remove('active');
            isDragging = false;
            currentTarget = null;
        });

        function addLayerItem(id, label, img) {
            if (layers.length === 0) layerList.innerHTML = '';
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 p-2 border-b border-[#111] hover:bg-ps-light cursor-pointer transition group';
            div.id = `panel-layer-${id}`;
            div.innerHTML = `
                <div class="w-6 h-6 bg-black border border-gray-600 bg-center bg-cover rounded-sm" style="background-image: url(${img})"></div>
                <div class="flex-1 truncate">${label}</div>
                <button onclick="removeLayer(${id})" class="text-red-500 font-bold px-1 opacity-0 group-hover:opacity-100 transition">×</button>
            `;
            div.onclick = () => {
                const el = document.getElementById(`layer-${id}`);
                el.style.outline = '3px solid #0078d4';
                setTimeout(() => el.style.outline = 'none', 1000);
                printArea.appendChild(el);
            };
            layerList.prepend(div);
            layers.push(id);
        }

        function removeLayer(id) {
            document.getElementById(`layer-${id}`)?.remove();
            document.getElementById(`panel-layer-${id}`)?.remove();
            layers = layers.filter(l => l !== id);
            if (layers.length === 0) layerList.innerHTML = '<div class="text-center mt-4 italic text-gray-600">Kanvas kosong</div>';
            updateStatus();
        }

        function clearAll() {
            if (confirm('Hapus semua foto di kanvas?')) {
                printArea.innerHTML = '';
                layerList.innerHTML = '<div class="text-center mt-4 italic text-gray-600">Kanvas kosong</div>';
                layers = [];
                updateStatus();
            }
        }

        function autoLayout() {
            const photos = Array.from(printArea.querySelectorAll('.photo-layer'));
            if (photos.length === 0) return;

            let currentX = 5; 
            let currentY = 5; 
            let maxHeightInRow = 0;
            const paperWidthPx = printArea.offsetWidth;
            const paperWidthMm = paperSelect.value === 'size-a3' ? 297 : 210;
            const mmToPxFactor = paperWidthPx / paperWidthMm;

            photos.forEach(photo => {
                const wMm = parseFloat(photo.style.width);
                const hMm = parseFloat(photo.style.height);

                if (currentX + wMm > paperWidthMm - 5) {
                    currentX = 5;
                    currentY += maxHeightInRow + 5;
                    maxHeightInRow = 0;
                }

                photo.style.left = (currentX * mmToPxFactor) + 'px';
                photo.style.top = (currentY * mmToPxFactor) + 'px';

                currentX += wMm + 2;
                if (hMm > maxHeightInRow) maxHeightInRow = hMm;
            });
        }

        function updateStatus() { layerCountLabel.textContent = layers.length; }

        function handlePrintAction() {
            if (layers.length === 0) return alert('Kanvas masih kosong.');
            window.print();
        }

        async function downloadPDFDirect() {
            if (layers.length === 0) return alert('Kanvas masih kosong.');
            loadingOverlay.style.display = 'flex';
            
            try {
                const { jsPDF } = window.jspdf;
                const paperType = paperSelect.value;
                let pW, pH;
                if (paperType === 'size-a4') { pW = 210; pH = 297; }
                else if (paperType === 'size-f4') { pW = 215; pH = 330; }
                else { pW = 297; pH = 420; }

                const canvas = await html2canvas(printArea, {
                    scale: 3, 
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    width: printArea.offsetWidth,
                    height: printArea.offsetHeight
                });

                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: [pW, pH]
                });

                pdf.addImage(imgData, 'JPEG', 0, 0, pW, pH);
                pdf.save(`Fami_Collection_${new Date().getTime()}.pdf`);
            } catch (error) {
                console.error(error);
                alert('Gagal membuat file PDF.');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        updatePaperSize();
    </script>
</body>
</html>
